= 离线消费记录同步到服务设计文档
v1.0, 2022-04-14
:doctype: article
:encoding: utf-8
:lang: zh
:toc:
:numbered:
:AUTHOR: wangmaojun


## 离线消费记录同步到服务设计

### 离线消费记录同步到服务设计思路

1. 消费机进行消费产生消费流水records

2. 一旦消费机恢复与 smface-server 心跳通信，设备调取 smface-server 接口 /request/heartbeat, 从请求参数中获取records，将其同步到
数据库中

[TIPS]
====
如果消费机处于记账模式下产生的消费，如上第二点的处理逻辑中还需要包含减扣用户的balance、llowance, 以及增加point
====

3. 服务应答设备，回传参数必须包含records参数，否则设备会认为本次发送的这批消费记录服务端没处理好，在下一次心跳过程中会继续发送上一批消费记录

[TIPS]
====
"records"://服务器已保存的id号，设备收到后根据此id对记录做已采集的标记，没有记录时为空
    [
        {"id":"1"},
        {"id":"2"},
        {"id":"3"},
        {"id":"4"},
        {"id":"5"}
    ]
====

## 程序实现流程

### /request/heartbeat

----
 /**
     * @param data
     * @return
     */
    @RequestMapping("heartbeat")
    public JSONObject heartbeat(@RequestBody JSONObject data) {
        logger.warn("松美消费机 start heartbeat ======================================");
        try {
            logger.warn("heartbeat received request data ===========================：" + JSON.toJSONString(data));
            String devId = data.getString("dev_id");
            logger.warn("heartbeat dev_id ===========================: " + devId);
            String serialno = data.getString("serialno");
            logger.warn(" heartbeat serialno ===========================: " + serialno);
            String transactionId = data.getString("transaction_id");
            logger.info("query device, the device id : ===============================" + devId);
            DeviceEntity deviceEntity = deviceService.queryByDeviceId(devId, serialno);
            if (deviceEntity != null) {
                deviceEntity.setLastHeartbeatTime(LocalDateTime.now());
                //1. update heart time
                logger.warn("heartbeat update heart time, the time: ====================================" + new Date());
                deviceService.update(deviceEntity);
            }
            //5. handle records
            JSONObject records = recordsService.handleRecords(data);
            if (records != null) {
                return records;
            }
            // 6. return heartbeat data
            JSONObject back = heartBeatService.handleHeartbeat(data);
            back.put("interval", GlobalConstant.interval);
            logger.warn("松美消费机 heartbeat return result ================================== :" + JSON.toJSONString(back));
            return back;
        } catch (Exception e) {
            e.printStackTrace();
            logger.error("松美消费机 heartbeat  failed, cause ==================================:  " + e.getMessage());
            return null;
        }
    }
----

### api value

api = "heartbeat"

## 修改心跳间隔时间

在服务端应答设备回传的参数可以修改心跳时间间隔，字段 interval

----
jsonObject.put("interval", 60000);
----


## 权限认证

注意：如果采用spring security 或者 Oauth2, 一定要将 /request/heartbeat 进行权限放行，不然设备无法调取接口

